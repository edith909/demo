-- ============================================
-- EXPERIMENT 5 (ORACLE VERSION):
-- SQL Subqueries and Correlated Queries
-- ============================================
-- Notes:
-- 1. Oracle does NOT support CREATE DATABASE / USE.
--    Run this script in the required Oracle schema/user.
-- 2. Data types adjusted:
--      INT      -> NUMBER
--      DECIMAL  -> NUMBER(p,s)
--      VARCHAR  -> VARCHAR2
-- 3. Multi-row INSERTs converted to INSERT ALL ... SELECT 1 FROM DUAL.
-- ============================================

-- ============================================
-- CREATE SAMPLE TABLES
-- ============================================

CREATE TABLE Department (
    dept_id   NUMBER PRIMARY KEY,
    dept_name VARCHAR2(100)
);

CREATE TABLE Employee (
    emp_id   NUMBER PRIMARY KEY,
    emp_name VARCHAR2(100),
    dept_id  NUMBER,
    salary   NUMBER(10,2),
    city     VARCHAR2(50),
    CONSTRAINT fk_emp_dept
        FOREIGN KEY (dept_id) REFERENCES Department(dept_id)
);

-- ============================================
-- INSERT SAMPLE DATA
-- ============================================

INSERT ALL
    INTO Department (dept_id, dept_name) VALUES (10, 'Computer')
    INTO Department (dept_id, dept_name) VALUES (20, 'IT')
    INTO Department (dept_id, dept_name) VALUES (30, 'HR')
    INTO Department (dept_id, dept_name) VALUES (40, 'Accounts')
SELECT 1 FROM DUAL;

INSERT ALL
    INTO Employee (emp_id, emp_name, dept_id, salary, city)
        VALUES (1, 'Rohan', 10, 45000, 'Pune')
    INTO Employee (emp_id, emp_name, dept_id, salary, city)
        VALUES (2, 'Sneha', 10, 55000, 'Mumbai')
    INTO Employee (emp_id, emp_name, dept_id, salary, city)
        VALUES (3, 'Amit',  20, 40000, 'Pune')
    INTO Employee (emp_id, emp_name, dept_id, salary, city)
        VALUES (4, 'Priya', 20, 60000, 'Delhi')
    INTO Employee (emp_id, emp_name, dept_id, salary, city)
        VALUES (5, 'Kiran', 30, 38000, 'Nashik')
    INTO Employee (emp_id, emp_name, dept_id, salary, city)
        VALUES (6, 'Meena', 30, 42000, 'Pune')
    INTO Employee (emp_id, emp_name, dept_id, salary, city)
        VALUES (7, 'Rahul', 40, 50000, 'Mumbai')
SELECT 1 FROM DUAL;

-- ============================================
-- PART 1: SIMPLE SUBQUERIES (NON-CORRELATED)
-- ============================================

-- 1. Single-row subquery ( = )
-- Employees who earn more than the average salary of ALL employees
SELECT emp_id, emp_name, salary
FROM   Employee
WHERE  salary > (
    SELECT AVG(salary)
    FROM   Employee
);

-- 2. Single-row subquery with MAX()
-- Employee(s) having the maximum salary
SELECT emp_id, emp_name, salary
FROM   Employee
WHERE  salary = (
    SELECT MAX(salary)
    FROM   Employee
);

-- 3. Multi-row subquery using IN
-- Employees whose dept_id is in departments having "IT" or "Computer"
SELECT emp_id, emp_name, dept_id, salary
FROM   Employee
WHERE  dept_id IN (
    SELECT dept_id
    FROM   Department
    WHERE  dept_name IN ('IT', 'Computer')
);

-- 4. Subquery using ANY
-- Employees whose salary is greater than ANY salary of employees in HR department (dept_id=30)
SELECT emp_id, emp_name, salary
FROM   Employee
WHERE  salary > ANY (
    SELECT salary
    FROM   Employee
    WHERE  dept_id = 30
);

-- 5. Subquery using ALL
-- Employees whose salary is greater than ALL salaries in HR department (dept_id=30)
SELECT emp_id, emp_name, salary
FROM   Employee
WHERE  salary > ALL (
    SELECT salary
    FROM   Employee
    WHERE  dept_id = 30
);

-- 6. Subquery in FROM clause (inline view)
-- Find average salary per department using subquery as a derived table
SELECT d.dept_name,
       t.avg_salary
FROM  (
        SELECT dept_id,
               AVG(salary) AS avg_salary
        FROM   Employee
        GROUP BY dept_id
      ) t
      INNER JOIN Department d
          ON d.dept_id = t.dept_id;

-- 7. Subquery in SELECT clause (scalar subquery)
-- Show employee with their department name using subquery
SELECT 
    e.emp_id,
    e.emp_name,
    e.salary,
    (SELECT d.dept_name
     FROM   Department d
     WHERE  d.dept_id = e.dept_id) AS department_name
FROM Employee e;

-- ============================================
-- PART 2: CORRELATED SUBQUERIES
-- (Subquery depends on outer query row)
-- ============================================

-- 8. Correlated subquery: employee whose salary >
--    average salary of their own department
SELECT e.emp_id, e.emp_name, e.dept_id, e.salary
FROM   Employee e
WHERE  e.salary > (
    SELECT AVG(e2.salary)
    FROM   Employee e2
    WHERE  e2.dept_id = e.dept_id
);

-- 9. Correlated subquery with EXISTS
-- Departments that have at least one employee
SELECT d.dept_id, d.dept_name
FROM   Department d
WHERE  EXISTS (
    SELECT 1
    FROM   Employee e
    WHERE  e.dept_id = d.dept_id
);

-- 10. Correlated subquery with NOT EXISTS
-- Departments that have NO employees
SELECT d.dept_id, d.dept_name
FROM   Department d
WHERE  NOT EXISTS (
    SELECT 1
    FROM   Employee e
    WHERE  e.dept_id = d.dept_id
);

-- 11. Correlated subquery: find highest paid employee
-- in each department
SELECT e.emp_id, e.emp_name, e.dept_id, e.salary
FROM   Employee e
WHERE  e.salary = (
    SELECT MAX(e2.salary)
    FROM   Employee e2
    WHERE  e2.dept_id = e.dept_id
);

-- 12. Correlated subquery with city condition
-- Employees whose salary is greater than
-- average salary of employees in SAME CITY
SELECT e.emp_id, e.emp_name, e.city, e.salary
FROM   Employee e
WHERE  e.salary > (
    SELECT AVG(e2.salary)
    FROM   Employee e2
    WHERE  e2.city = e.city
);

-- 13. Correlated subquery used like filtering
-- Employees who are NOT highest paid in their department
SELECT e.emp_id, e.emp_name, e.dept_id, e.salary
FROM   Employee e
WHERE  e.salary < (
    SELECT MAX(e2.salary)
    FROM   Employee e2
    WHERE  e2.dept_id = e.dept_id
);

-- ============================================
-- END OF SCRIPT
-- ============================================
